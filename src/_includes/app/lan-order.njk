<!--
  04.08.2023 created for DB-Tools
  Dummy für Portbestellung
  -->

<!-- The Form -->
<style>
.w3-check,.w3-radio{width:20px;height:20px;position:relative;top:2px}
.w3-check { margin-right:8px; }
.w3-radio { margin-right:4px; }

  	#rDisplay, #rSubmit {
		cursor: pointer;
	}
</style>
<script>const form_version = "0.5";</script>


<div class="w3-container w3-card-4 w3-light-grey w3-text-black">
	<form id="lanOrderMail">
		<!-- Besteller -->
		<h4 class="w3-text-blue">Besteller</h4>
		<div class="w3-row">
			<div class="w3-col s12 m9 l5">
				<input id='bestname' class="w3-input w3-border w3-padding-small" name="besteller" required type="text" placeholder="Besteller">
			</div>
			<div class="w3-col s12 m3 l2">
				<input id='bestoe' class="w3-input w3-border w3-padding-small" name="OE" type="text" placeholder="OE">
			</div>
			<div class="w3-col s12 m12 l5">
				<input id='bestmail' class="w3-input w3-border w3-padding-small" name="mail" required type="text" placeholder="Mailadresse">
			</div>
		</div>

		<!-- Verkehrsstation -->
		<h4 class="w3-text-blue">Verkehrsstation</h4>
		<div class="w3-row">
			<div class="w3-col s4 m3 l2">
				<input id='bfnr' class="w3-input w3-border w3-padding-small" name="bfnr" required type="text" placeholder="Bf-Nr."
					   title="Autorisierte Benutzer können durch Eingabe der Bahnhofsnummer verschiedene andere Felder automatisch ausfüllen lassen."
				>
			</div>
			<div class="w3-col s8 m9 l10">
				<input id='bfname' class="w3-input w3-border w3-padding-small" name="bahnhof" required type="text" placeholder="Bahnhof">
			</div>
			<div class="w3-col s12 m12 l12">
				<input id='bfanschrift' class="w3-input w3-border w3-padding-small" name="anschrift" required type="text" placeholder="Anschrift">
			</div>
			<div class="w3-col s6 m4 l6 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">Bahn- und Kostenstelle</label>
			</div>
			<div class="w3-col s6 m4 l3">
				<input id='bahnstelle' class="w3-input w3-border w3-padding-small" name="bahnstelle" required type="text" placeholder="Bahnstelle">
			</div>
			<div class="w3-col s6 m4 l3">
				<input id='kostenstelle' class="w3-input w3-border w3-padding-small" name="kostenstelle" type="text" placeholder="Kostenstelle" value="68700">
			</div>
		</div>
		<!-- Gebäudeautomation -->
		<h4 class="w3-text-blue w3-section">Örtliche Gegebenheiten</h4>
		<div class="w3-row w3-section">
			<div class="w3-col s12 m12 l12">
				<input id='standort' class="w3-input w3-border w3-padding-small" name="standort" type="text" placeholder="Gebäude oder Standort im Bahnhof">
			</div>
			<div class="w3-col s6 m6 l6">
				<input id='raum' class="w3-input w3-border w3-padding-small" name="raum" type="text" placeholder="Flur / Etage / Raum">
			</div>
			<div class="w3-col s6 m6 l6">
				<input id='idg' class="w3-input w3-border w3-padding-small" name="idg" type="text" placeholder="IDG-Nr falls bekannt">
			</div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6 l3"><input id='ganew' class="w3-radio" type="radio" name="gatype" value="Neuanschluss">	<label>Neuer Anschluß</label></div>
			<div class="w3-col a12 m6 l3"><input id='gaext' class="w3-radio" type="radio" name="gatype" value="Erweiterung"> 	<label>GA Erweiterung</label></div>
			<div class="w3-col a12 m6 l3"><input id='gachg' class="w3-radio" type="radio" name="gatype" value="GA-Umbau">	 	<label>GA Umbau</label> </div>
			<div class="w3-col a12 m6 l3"><input id='gaprj' class="w3-radio" type="radio" name="gatype" value="Bauprojekt">		<label>Bauprojekt</label> </div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6  l3"><input id='gaexist'	class="w3-check" type="checkbox" name="gaExist"><label>GA bereits vorhanden</label></div>
			<div class="w3-col a12 m6  l3"><input id='gafunk'   class="w3-check" type="checkbox" name="gaFunk"><label>Funkanbindung prüfen</label> </div>
			<div class="w3-col a12 m12 l6"><input id='gabestand'class="w3-check" type="checkbox" name="gaBestand"><label>Bestandschutz wird beantragt</label></div>
		</div>
		<!-- Netzwerk -->
		<h4 class="w3-text-blue">Angaben zum Netzwerk</h4>
		<div class="w3-row">
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">Subnetz</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='subnetz' name="subnetz"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="Subnetz wird vom Netzwerk-Team eingetragen">
			</div>
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">IP-Adresse</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='ipadresse' name="ipaddress"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="IP-Adresse wird vom Netzwerk-Team vergeben">
			</div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6 l3"><input id='gabbmd' class="w3-check" type="checkbox" name="gaBBMD"><label>Gerät ist ein <b>BBMD</b></label></div>
			<div class="w3-col a12 m6 l3"><input id='gasystem' class="w3-check" type="checkbox" name="gaGateway"><label>BACnet System Device</label> </div>
		</div>

		<div class="w3-row w3-stretch w3-section">
			<div class="w3-padding w3-third">
				<input id='rDisplay' class="w3-input w3-border" name="registerDisplay" type="button" value="Anzeigen" title="Anzeigen des Text der Bestellung auf dem Bildschirm">
			</div>
			<div class="w3-padding w3-twothird">
				<input id='rSubmit' class="w3-input w3-border" name="registerSubmit" type="submit" value="Senden" title="Versenden der Bestellung per Outlook bzw. Mail-Programm">
			</div>
		</div>
	</form>
</div>


<script>
document.addEventListener("DOMContentLoaded", function(event) {

	document.getElementById('bfnr').addEventListener("change", lookupBahnhof);
	document.getElementById('gabbmd').addEventListener("change", lookupBahnhof);
	document.getElementById('rDisplay').addEventListener("click", function(event) {
		sendMail(false);
	});
	document.getElementById('lanOrderMail').addEventListener("submit", function(event) {
		event.preventDefault(); /* before the code */
		sendMail(true);
	});

	itbf8_createIndices();
	document.getElementById('username').innerHTML = user.name();
	document.getElementById('dataversion').innerHTML = "Form " + form_version;	
});

function lookupBahnhof(event) {		/* Automatik: Nachschlagen deer Bahnhofsdaten, wenn angemeldet */ 
	if (! user.status()) return;	/* Nachschlagen nur mit gültiger Anmeldung */
	console.log("lookupBahnhof", user.name(), user.status());
	
	const bfnr = document.getElementById('bfnr').value.replace(/[<>&"']/g, '?');
	console.log('bfnr', bfnr);
	const item = itbf8_retrieve_number('**', bfnr);
	console.log('item', item);
	if (item) {
		const domName = document.getElementById('bfname');			
		const domAnschrift = document.getElementById('bfanschrift');	
		const domBahnstelle = document.getElementById('bahnstelle');	

		domName.value = item.vst_name;
		domAnschrift.value = item.vst_strasse.concat((item.vst_strasse == "")?'':', ', item.vst_plz, ' ', item.vst_ort);
		domBahnstelle.value = item.bahnstelle;
		document.getElementById('subnetz').value = item.subnetz;
		document.getElementById('ipadresse').value = (document.getElementById('gabbmd').checked) ? itbf8_scheme("offset", item.subnetz, 21) : '';
	}
	
	
	
}

/**
 *
	id='bestname'		name="besteller" 	required
	id='bestoe'			name="OE"
	id='bestmail'		name="mail"			required
	id='bfnr'			name="bfnr"			required
	id='bfname'			name="bahnhof"		required
	id='bfanschrift'	name="anschrift"	required	
	id='bahnstelle'		name="bahnstelle"	required
	id='kostenstelle'	name="kostenstelle"
	id='standort'		name="standort"
	id='raum'			name="raum"
	id='idg'			name="idg"
	id='ganew'			name="gatype" value="new"
	id='gaext'			name="gatype" value="extend"
	id='gachg'			name="gatype" value="umbau"
	id='gaprj'			name="gatype" value="project"
	id='gaexist'		name="gaExist"
	id='gafunk'			name="gaFunk"
	id='gabestand'		name="gaBestand"
	id='subnetz'		name="subnetz"
	id='ipadresse'		name="ipaddress"
	id='gabbmd' 		name="gaBBMD"
	id='gasystem' 		name="gaGateway"
	id='rDisplay' 		name="registerDisplay"
	id='rSubmit' 		name="registerSubmit"
 *
 * */
 
function getRadiobuttonValue(radioname) {
	var rdBtn = document.querySelectorAll("input[name='"+radioname+"']");
	for (let i= 0; i < rdBtn.length; i++) {
		if(rdBtn[i].checked == true) { return rdBtn[i].value; }
	}
	return '';
}
function getCheckboxString(checkbox, description) {
	if (document.getElementById(checkbox).checked) return description;
	return "";
}



function sendMail(doSend) {
	
	let d_bestname = document.getElementById('bestname').value.replace(/[<>&"']/g, '?');	
	const d_bestoe = document.getElementById('bestoe').value.replace(/[<>&"']/g, '?');	
	let d_bestmail = document.getElementById('bestmail').value.replace(/[<>&"']/g, '?');	
	let d_bfnr = document.getElementById('bfnr').value.replace(/[<>&"']/g, '?');			
	let d_bfname = document.getElementById('bfname').value.replace(/[<>&"']/g, '?');			
	let d_bfanschrift = document.getElementById('bfanschrift').value.replace(/[<>&"']/g, '?');	
	let d_bahnstelle = document.getElementById('bahnstelle').value.replace(/[<>&"']/g, '?');		
	const d_kostenstelle = document.getElementById('kostenstelle').value.replace(/[<>&"']/g, '?');	
	const d_standort = document.getElementById('standort').value.replace(/[<>&"']/g, '?');		
	const d_raum = document.getElementById('raum').value.replace(/[<>&"']/g, '?');			
	const d_idg = document.getElementById('idg').value.replace(/[<>&"']/g, '?');
	const d_gatype = getRadiobuttonValue('gatype').replace(/[<>&"']/g, '?');		
	const d_gaexist = getCheckboxString('gaexist', "\n - GA am Standort bereits vorhanden");
	const d_gafunk = getCheckboxString('gafunk', "\n - Empfehlung zur Funkanbindung");
	const d_gabestand = getCheckboxString('gabestand', "\n - Bestandsschutz wird beantragt");
	const d_subnetz = document.getElementById('subnetz').value.replace(/[<>&"']/g, '?');	
	const d_ipadresse = document.getElementById('ipadresse').value.replace(/[<>&"']/g, '?');
	const d_gabbmd = getCheckboxString('gabbmd', "\n - Anschluss ist für BBMD");
	const d_gasystem = getCheckboxString('gasystem', "\n - Anschluss ist für BACnet Systemgerät");
	
	const receiver = d_bestmail; /* "{{ site.mail | d(site.author.mail) }}" */
	
	let incomplete = false;
	if (d_bestname.length == 0)   { incomplete=true; d_bestname = "NAME DES BESTELLERS NICHT ANGEGEBEN."; }
	if (d_bestmail.length == 0)   { incomplete=true; d_bestmail = "MAIL DES BESTELLERS NICHT ANGEGEBEN."; }
	if (d_bfnr.length == 0)		  { incomplete=true; d_bfnr = "KEINE BAHNHOFSUMMER ANGEGEBEN."; }
	if (d_bfname.length == 0)	  { incomplete=true; d_bfname = "KEIN BAHNHOFSNAME ANGEGEBEN."; }
	if (d_bfanschrift.length == 0){ incomplete=true; d_bfanschrift = "KEINE BAHNHOFSANSCHRIFT ANGEGEBEN."; }
	if (d_bahnstelle.length == 0) { incomplete=true; d_bahnstelle = "KEINE BAHNSTELLE ANGEGEBEN."; }
	
	const subject = "DB-TIM: Bestellung eines LAN-Ports zur Gebäudeautomation";
	
	let body = subject+"\n" +
				"\nBesteller:\t" + d_bestname +
				"\nOrga:    \t" + d_bestoe +
				"\nMail:    \t" + d_bestmail +
				"\nBahnhof-Nr.:\t" + d_bfnr +
				"\n" + "Bahnhof:\t" + d_bfname +
				"\n" + "Bf. Anschrift:\t" + d_bfanschrift +
				"\n" + "Bahnstelle:\t" + d_bahnstelle +
				"\n" + "Kostenstelle:\t" + d_kostenstelle +
				"\n" + "Standort:\t" + d_standort +
				"\n" + "Raum:    \t" + d_raum +
				"\n" + "IDG-Nr.: \t" + d_idg +
				"\n" + "GA-Typ:  \t" + d_gatype +
				d_gaexist + d_gafunk + d_gabestand +
				"\n" + "Subnetz:\t" + d_subnetz +
				"\n" + "IPadresse:\t" + d_ipadresse +
				d_gabbmd + d_gasystem +
				"\n\n\tDiese Mail wurde automatisch erstellt.\n";
	
		if (incomplete) body += "\n\tDie Bestellung ist unvollständig und kann nicht bearbeitet werden.\n";
	
console.log('mailto:',receiver,'\nsubject',subject,'\n&body',encodeURIComponent(body));
	if (doSend) {
		const win = window.open('mailto:'+receiver+'?subject='+subject+'&body='+encodeURIComponent(body));
		win.close();
	} else {
		document.getElementById('orderBody').innerHTML = body;
		document.getElementById('order').style.display='block';
	}	
}
</script>
