<!--
  04.08.2023 created for DB-Tools
  Dummy für Portbestellung
  -->

<!-- The Form -->
<style>
	.w3-check,.w3-radio{width:20px;height:20px;position:relative;top:2px}
	.w3-check { margin-right:8px; }
	.w3-radio { margin-right:4px; }

  	#rDisplay, #rSubmit {
		cursor: pointer;
	}
	input {color:#000!important;background-color:#f8fff8!important}
	.w3-section-small{margin-top:8px!important;margin-bottom:8px!important}
</style>

<script>const form_version = "0.7.2";</script>

<div class="w3-container w3-card-4 w3-text-black">
	<form id="lanOrderMail">
		<!-- Besteller -->
		<h4 class="w3-text-blue">Besteller</h4>
		<div class="w3-row">
			<div class="w3-col s12 m9 l5">
				<input id='bestname' class="w3-input w3-border w3-padding-small" name="besteller" required type="text" placeholder="Besteller">
			</div>
			<div class="w3-col s12 m3 l2">
				<input id='bestoe' class="w3-input w3-border w3-padding-small" name="OE" type="text" placeholder="OE">
			</div>
			<div class="w3-col s12 m12 l5">
				<input id='bestmail' class="w3-input w3-border w3-padding-small" name="mail" required type="email" placeholder="Mailadresse">
			</div>
		</div>

		<!-- Verkehrsstation -->
		<h4 class="w3-text-blue">Verkehrsstation</h4>
		<div class="w3-row">
			<div class="w3-col s3 m2 l1">
				<input id='bfnr' class="w3-input w3-border w3-padding-small" name="bfnr" required type="text" placeholder="Bf-Nr."
					   title="Autorisierte Benutzer können durch Eingabe der Bahnhofsnummer auch die Angaben zum Netzwerk autoomatisch ausfüllen lassen."
				>
			</div>
			<div class="w3-col s9 m10 l11">
				<input id='bfname' class="w3-input w3-border w3-padding-small" name="bahnhof" required type="text" placeholder="Bahnhof">
			</div>
			<div class="w3-col s3 m2 l1">
				<input id='bf100' class="w3-input w3-border w3-padding-small" name="betriebsstelle" type="text" placeholder="RIL100">
			</div>
			<div class="w3-col s9 m10 l11">
				<input id='bfanschrift' class="w3-input w3-border w3-padding-small" name="anschrift" required type="text" placeholder="Anschrift">
				<input id='bfstrasse' name="strasse" type="hidden">
				<input id='bfplz' name="plz" type="hidden">
				<input id='bfort' name="ort" type="hidden">
			</div>
			<div class="w3-col s6 m4 l6 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">Bahn- und Kostenstelle</label>
			</div>
			<div class="w3-col s6 m4 l3">
				<input id='bahnstelle' class="w3-input w3-border w3-padding-small" name="bahnstelle" required type="text" placeholder="Bahnstelle">
			</div>
			<div class="w3-col s6 m4 l3">
				<input id='kostenstelle' class="w3-input w3-border w3-padding-small" name="kostenstelle" type="text" placeholder="Kostenstelle" value="68700">
			</div>
		</div>
		<!-- Gebäudeautomation -->
		<h4 class="w3-text-blue w3-section">Örtliche Gegebenheiten</h4>
		<div class="w3-row w3-section">
			<div class="w3-col s12 m12 l12">
				<input id='standort' class="w3-input w3-border w3-padding-small" name="standort" type="text" placeholder="Gebäude oder Standort im Bahnhof">
			</div>
			<div class="w3-col s6 m6 l6">
				<input id='raum' class="w3-input w3-border w3-padding-small" name="raum" type="text" placeholder="Flur / Etage / Raum">
			</div>
			<div class="w3-col s6 m6 l6">
				<input id='idg' class="w3-input w3-border w3-padding-small" name="idg" type="text" placeholder="IDG-Nr falls bekannt">
			</div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6 l3"><input id='ganew' class="w3-radio" type="radio" name="gatype" value="Neuanschluss">	<label>Neuer Anschluß</label></div>
			<div class="w3-col a12 m6 l3"><input id='gaext' class="w3-radio" type="radio" name="gatype" value="Erweiterung"> 	<label>GA Erweiterung</label></div>
			<div class="w3-col a12 m6 l3"><input id='gachg' class="w3-radio" type="radio" name="gatype" value="GA-Umbau">	 	<label>GA Umbau</label> </div>
			<div class="w3-col a12 m6 l3"><input id='gaprj' class="w3-radio" type="radio" name="gatype" value="Bauprojekt">		<label>Bauprojekt</label> </div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6  l3"><input id='gaexist'	class="w3-check" type="checkbox" name="gaExist"><label>GA bereits vorhanden</label></div>
			<div class="w3-col a12 m6  l3"><input id='gafunk'   class="w3-check" type="checkbox" name="gaFunk"><label>Funkanbindung prüfen</label> </div>
			<div class="w3-col a12 m12 l6"><input id='gabestand'class="w3-check" type="checkbox" name="gaBestand"><label>Bestandschutz wird beantragt</label></div>
		</div>
		<!-- Netzwerk -->
		<h4 class="w3-text-blue">Angaben zum Netzwerk</h4>
		<div class="w3-row">
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">Subnetz</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='subnetz' name="subnetz"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="Subnetz wird vom Netzwerk-Team eingetragen">
			</div>
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">IP-Adresse</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='ipadresse' name="ipaddress"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="IP-Adresse wird vom Netzwerk-Team vergeben">
			</div>
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">Subnetz-Maske</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='subnetzmask' name="subnetzmask"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="Subnetz-Maske wird berechnet">
			</div>
			<div class="w3-col m3 l2 w3-hide-small" style="max-height:2.2em;overflow:hidden">
				<label class="w3-input w3-border w3-padding-small">IP-Bereich</label>
			</div>
			<div class="w3-col s6 m9 l4">
				<input id='iprange' name="iprange"
						class="w3-input w3-border w3-padding-small" readonly type="text"
						placeholder="IP-Adressbereich wird automatisch vergeben.">
			</div>
		</div>
		<div class="w3-row w3-border w3-padding-small">
			<div class="w3-col a12 m6 l3"><input id='gabbmd' class="w3-check" type="checkbox" name="gaBBMD"><label>Gerät ist ein <b>BBMD</b></label></div>
			<div class="w3-col a12 m6 l3"><input id='gasystem' class="w3-check" type="checkbox" name="gaGateway"><label>BACnet System Device</label> </div>
		</div>

		<div class="w3-row w3-padding w3-stretch w3-section">
			<div class="w3-col s12 m6 l3">
				<input id='rDisplay' class="w3-input w3-border w3-green w3-hover-pale-green" 
					   name="orderDisplay" type="button" value="Anzeigen" 
					   title="Anzeigen des Text der Bestellung auf dem Bildschirm">
			</div>
			<div class="w3-col s12 m6 l3">
				<input id='rCopy' class="w3-input w3-border w3-green w3-hover-pale-green" 
					   name="orderCopy" type="button" value="Kopieren" 
					   title="Die Bestellung wird in das Clipboard geladen und kann mit Strg-V abgerufen werden">
			</div>
			<div id='rFileDiv' class="w3-col s12 m6 l3">
				<input id='rFile' class="w3-input w3-border w3-green w3-hover-pale-green" 
					   name="orderFile" type="button" value="Download"
					   title="Die Bestellung wird sowohl als Textdatei als auch als CSV-Datei heruntergeladen. Die CSV-Datei kann direkt in die Systel Mapping-Liste (Excel) importiert werden.">
			</div>
			<div id='rSendDiv' class="w3-col s12 m6 l3">
				<input id='rSubmit' class="w3-input w3-border w3-green w3-hover-pale-green" 
					   name="orderSubmit" type="submit" value="Senden" 
					   title="Versenden der Bestellung per Outlook bzw. Mail-Programm">
			</div>
		</div>		
		
		
	</form>
</div>

<script src="static/res/lanorder.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(event) {

	document.getElementById('bfnr').addEventListener("change", lookupBahnhof);
	document.getElementById('gabbmd').addEventListener("change", lookupBahnhof);
	document.getElementById('gasystem').addEventListener("change", lookupBahnhof);
	document.getElementById('rDisplay').addEventListener("click", function(event) {
		submitLanOrder('show');
	});
	document.getElementById('rCopy').addEventListener("click", function(event) {
		submitLanOrder('copy');
	});
	document.getElementById('rFile').addEventListener("click", function(event) {
		submitLanOrder('file');
	});
	document.getElementById('lanOrderMail').addEventListener("submit", function(event) {
		event.preventDefault(); /* before the code */
		submitLanOrder('send');
	});

	itbf8_createIndices();
	document.getElementById('username').textContent = user.name();
	document.getElementById('dataversion').textContent = "Form " + form_version;	

	renderDownloadButton (user.status());
});

function lookupBahnhof(event) {		/* Automatik: Nachschlagen deer Bahnhofsdaten, wenn angemeldet */ 
	
	const bfnr = document.getElementById('bfnr').value;
	if (! bfnr) return;
	const item = itbf8_retrieve_number('**', bfnr);
	if (item) {
		const is_bbmd = document.getElementById('gabbmd').checked;
		const is_system = document.getElementById('gasystem').checked;
		document.getElementById('bfname').value = item.vst_name;
		document.getElementById('bf100').value = item.vst_100;
		document.getElementById('bfanschrift').value = item.vst_strasse.concat((item.vst_strasse == "")?'':', ', item.vst_plz, ' ', item.vst_ort);
		document.getElementById('bfstrasse').value = item.vst_strasse; /* hidden */
		document.getElementById('bfplz').value = item.vst_plz; /* hidden */
		document.getElementById('bfort').value = item.vst_ort; /* hidden */
		if (! user.status()) return;	/* Nachschlagen von IPs nur mit gültiger Anmeldung */
		document.getElementById('bahnstelle').value = item.bahnstelle;
		document.getElementById('subnetz').value = item.subnetz;
		document.getElementById('ipadresse').value = (is_bbmd) ? itbf8_scheme("offset", item.subnetz, 21) : '';
		document.getElementById('subnetzmask').value = network_ipmask(item.subnetz);
		document.getElementById('iprange').value = (is_bbmd || is_system) ? itbf8_scheme("rg-sys", item.subnetz) : itbf8_scheme("rg-dev", item.subnetz);
	} else {
		document.getElementById('bfname').value = "";
		document.getElementById('bf100').value = "";
		document.getElementById('bfanschrift').value = "";
		document.getElementById('bfstrasse').value = ""; /* hidden */
		document.getElementById('bfplz').value = ""; /* hidden */
		document.getElementById('bfort').value = ""; /* hidden */
		document.getElementById('bahnstelle').value = "";
		document.getElementById('subnetz').value = "";
		document.getElementById('ipadresse').value = "";
		document.getElementById('subnetzmask').value = "";
		document.getElementById('iprange').value = "";
	}
}

function renderDownloadButton(showit) {
	const fileDiv = document.getElementById('rFileDiv');
	const sendDiv = document.getElementById('rSendDiv');

	if (showit) {		/* <div class="w3-col s12 m6 l3"> */
		sendDiv.classList.remove('m12');	
		sendDiv.classList.remove('l6');
		sendDiv.classList.add('m6');
		sendDiv.classList.add('l3');
		fileDiv.style.display = 'block';
} else {				/* <div class="w3-col s12 m12 l6"> */
		sendDiv.classList.remove('m6');
		sendDiv.classList.remove('l3');
		sendDiv.classList.add('m12');
		sendDiv.classList.add('l6');
		fileDiv.style.display = 'none';
	}
}

/**
 *
	id='bestname'		name="besteller" 	required
	id='bestoe'			name="OE"
	id='bestmail'		name="mail"			required
	id='bfnr'			name="bfnr"			required
	id='bfname'			name="bahnhof"		required
	id='bf100'			name="betriebsstelle"
	id='bfanschrift'	name="anschrift"	required	
	id='bahnstelle'		name="bahnstelle"	required
	id='kostenstelle'	name="kostenstelle"
	id='standort'		name="standort"
	id='raum'			name="raum"
	id='idg'			name="idg"
	id='ganew'			name="gatype" value="new"
	id='gaext'			name="gatype" value="extend"
	id='gachg'			name="gatype" value="umbau"
	id='gaprj'			name="gatype" value="project"
	id='gaexist'		name="gaExist"
	id='gafunk'			name="gaFunk"
	id='gabestand'		name="gaBestand"
	id='subnetz'		name="subnetz"
	id='ipadresse'		name="ipaddress"
	id='subnetzmask'	name="subnetzmask"
	id='iprange'		name="iprange"
	id='gabbmd' 		name="gaBBMD"
	id='gasystem' 		name="gaGateway"
	id='rDisplay' 		name="registerDisplay"
	id='rSubmit' 		name="registerSubmit"
 *
 * */
 
function getRadiobuttonValue(radioname) {
	var rdBtn = document.querySelectorAll("input[name='"+radioname+"']");
	for (let i= 0; i < rdBtn.length; i++) {
		if(rdBtn[i].checked == true) { return rdBtn[i].value; }
	}
	return '';
}
function getCheckboxString(checkbox, description) {
	if (document.getElementById(checkbox).checked) return description;
	return "";
}

function submitLanOrder(cmd) {
	
	let d_bestname = document.getElementById('bestname').value;	
	const d_bestoe = document.getElementById('bestoe').value;	
	let d_bestmail = document.getElementById('bestmail').value;	
	let d_bfnr = document.getElementById('bfnr').value;			
	let d_bfname = document.getElementById('bfname').value;			
	let d_bf100 = document.getElementById('bf100').value;			
	let d_bfanschrift = document.getElementById('bfanschrift').value;	
	let d_bahnstelle = document.getElementById('bahnstelle').value;		
	const d_kostenstelle = document.getElementById('kostenstelle').value;	
	const d_standort = document.getElementById('standort').value;		
	const d_raum = document.getElementById('raum').value;			
	const d_idg = document.getElementById('idg').value;
	const d_gatype = getRadiobuttonValue('gatype');		
	const d_gaexist = getCheckboxString('gaexist', "\n - GA am Standort bereits vorhanden");
	const d_gafunk = getCheckboxString('gafunk', "\n - Empfehlung zur Funkanbindung");
	const d_gabestand = getCheckboxString('gabestand', "\n - Bestandsschutz wird beantragt");
	const d_subnetz = document.getElementById('subnetz').value;	
	const d_ipadresse = document.getElementById('ipadresse').value;
	const d_subnetzmask = document.getElementById('subnetzmask').value;	
	const d_iprange = document.getElementById('iprange').value;
	const d_gabbmd = getCheckboxString('gabbmd', "\n - Anschluss ist für BBMD");
	const d_gasystem = getCheckboxString('gasystem', "\n - Anschluss ist für BACnet Systemgerät");
	
	
	let incomplete = false;
	if (d_bestname.length == 0)   { incomplete=true; d_bestname = "NAME DES BESTELLERS NICHT ANGEGEBEN."; }
	if (d_bestmail.length == 0)   { incomplete=true; d_bestmail = "MAIL DES BESTELLERS NICHT ANGEGEBEN."; }
	if (d_bfnr.length == 0)		  { incomplete=true; d_bfnr = "KEINE BAHNHOFSUMMER ANGEGEBEN."; }
	if (d_bfname.length == 0)	  { incomplete=true; d_bfname = "KEIN BAHNHOFSNAME ANGEGEBEN."; }
	if (d_bfanschrift.length == 0){ incomplete=true; d_bfanschrift = "KEINE BAHNHOFSANSCHRIFT ANGEGEBEN."; }
	if (d_bahnstelle.length == 0) { incomplete=true; d_bahnstelle = "KEINE BAHNSTELLE ANGEGEBEN."; }
	
	const receiver = (d_bestmail) ? d_bestmail : "{{ site.mail | d(site.author.mail) }}";
	const subject = "DB-TIM: Bestellung eines LAN-Ports zur Gebäudeautomation";
	
	let body = subject+"\n" +
				"\nBesteller:\t" + d_bestname +
				"\nOrga:    \t" + d_bestoe +
				"\nMail:    \t" + d_bestmail +
				"\nBahnhof-Nr.:\t" + d_bfnr +
				"\n" + "Bahnhof:\t" + d_bfname +
				"\n" + "Bf. Anschrift:\t" + d_bfanschrift +
				"\n" + "Bahnstelle:\t" + d_bahnstelle +
				"\n" + "Kostenstelle:\t" + d_kostenstelle +
				"\n" + "Standort:\t" + d_standort +
				"\n" + "Raum:    \t" + d_raum +
				"\n" + "IDG-Nr.: \t" + (d_idg || "unbekannt") +
				"\n" + "GA-Typ:  \t" + d_gatype +
				d_gaexist + d_gafunk + d_gabestand +
				"\n" + "Subnetz:\t" + (d_subnetz || "wird vom Netzwerk-Team eingetragen.") +
				"\n" + "IP-Adresse:\t" + (d_ipadresse || "wird vom Netzwerk-Team vergeben.") +
				d_gabbmd + d_gasystem +
				"\n\n\tDiese Mail wurde automatisch erstellt.\n";
	
	if (incomplete) body += "\n\tDie Bestellung ist unvollständig und kann nicht bearbeitet werden.\n";
	
	switch (cmd) {
		case 'show':
						doAlert('show');
						document.getElementById('orderBody').textContent = body;
						document.getElementById('order').style.display='block';
						break;
		case 'copy':
						copyToClipboard(body);
						doAlert('copy');
						break;
		case 'send':
						copyToClipboard(body); /* just to ensure, that the mailbody is available, when the link fails */
						sendMail (receiver, subject, body);
						break;
		case 'file':	
						const txtfile = orderWriteText(body);
						const csvfile = orderWriteData({
								bestname: d_bestname,
								bestmail: d_bestmail,
								bfnr: d_bfnr,		
								bfname: d_bfname,		
								bf100: document.getElementById('bf100').value,		
								bfstrasse: document.getElementById('bfstrasse').value,
								bfplz: document.getElementById('bfplz').value,
								bfort: document.getElementById('bfort').value,
								bahnstelle: d_bahnstelle,	
								kostenstelle: d_kostenstelle,
								standort: d_standort,	
								raum: d_raum,		
								idg: d_idg,
								subnetz: d_subnetz,
								ipadresse: d_ipadresse,
								subnetzmask: d_subnetzmask,
								iprange: d_iprange,
								idg: d_idg
						});
						doAlert('file', txtfile, csvfile);
						break;
		default:		console.log('submitLanOrder', cmd);
						console.log('mailbody', body);
	}	
}

function doAlert(cmd, text1, text2) {
	let content = '';
	switch (cmd) {
		case 'show':
						document.getElementById('orderCopy').style.visibility  = 'visible';
						content = text1;
						break;
		case 'copy':
						document.getElementById('orderCopy').style.visibility  = 'hidden';
						content = "Der Text der Bestellung wurde ins Clipboard kopiert und kann von dort mit Strg-V abgerufen werden."
						break;
		case 'send':
						break;
		case 'file':	
						document.getElementById('orderCopy').style.visibility  = 'hidden';
						content = "Im Download-Verzeichnis wurden die folgende Dateien angelegt:\n\n"
								+ "\t'" + text1 + "' enthält den Text der Bestellung. (Editor)\n"
								+ "\t'" + text2 + "' enthält die Systel-Mapping-Liste im CSV-Format (Excel).\n"
								+ "\n";

						break;
	}
	if (content) {	
		document.getElementById('orderBody').textContent = content;
		document.getElementById('order').style.display='block';
	}
}
</script>
